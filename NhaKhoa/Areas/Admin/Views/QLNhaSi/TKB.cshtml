@using PagedList.Mvc
@using PagedList
@model NhaKhoa.Models.ThoiKhoaBieuViewModel

@{
    ViewBag.Title = "TKB";
    Layout = "~/Areas/Admin/Views/Shared/Layout.cshtml";
    var now = DateTime.Now;

    // Tính số ngày chênh lệch giữa ngày hiện tại và Thứ Hai của tuần hiện tại
    var daysUntilMonday = ((int)now.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;

    // Lấy ngày bắt đầu của tuần (Thứ Hai)
    var monday = now.AddDays(-daysUntilMonday);

    // Lấy ngày kết thúc của tuần (Chủ Nhật)
    var sunday = monday.AddDays(6);
    int a = 0;
    int numberweek = 0;
    string temp = "";
}

<header class="cd-main-header text-center flex flex-column flex-center">
    <h1 class="text-xl">THỜI GIAN BIỂU</h1>
    <a class="btn--primary" href="@Url.Action("ThemThoiKhoaBieu","QLNhaSi","Admin")">Thêm lịch làm việc</a>
</header>

<label for="weekSelect">Chọn Tuần:</label>
<select id="weekSelect" onchange="location.href=this.value;">
    @foreach (var week in Model.weeks)
    {
        numberweek++;
        <option value="@Url.Action("TKB", new { page = 1, selectedWeek = week.ToString("yyyy-MM-dd") })"
                @(week == Model.SelectedWeek ? "selected" : "")>
            Tuần @numberweek: @week.ToString("dd/MM/yyyy") - @week.AddDays(6).ToString("dd/MM/yyyy")
        </option>
    }
</select>

<div class="cd-schedule cd-schedule--loading margin-top-lg margin-bottom-lg js-cd-schedule">
    @if (Model.DanhSachThu.Any())
    {
        <div class="cd-schedule__timeline">
            <ul>
                <li><span>09:00</span></li>
                <li><span>09:30</span></li>
                <li><span>10:00</span></li>
                <li><span>10:30</span></li>
                <li><span>11:00</span></li>
                <li><span>11:30</span></li>
                <li><span>12:00</span></li>
                <li><span>12:30</span></li>
                <li><span>13:00</span></li>
                <li><span>13:30</span></li>
                <li><span>14:00</span></li>
                <li><span>14:30</span></li>
                <li><span>15:00</span></li>
                <li><span>15:30</span></li>
                <li><span>16:00</span></li>
                <li><span>16:30</span></li>
                <li><span>17:00</span></li>
                <li><span>17:30</span></li>
                <li><span>18:00</span></li>
            </ul>
        </div> <!-- .cd-schedule__timeline -->

        <div class="cd-schedule__events">
            <ul>
                @foreach (var daySchedule in Model.DanhSachThu)
                {
                    <li class="cd-schedule__group">
                        <div class="cd-schedule__top-info"><span>@daySchedule.TenThu</span></div>
                        <ul>
                            @foreach (var eventItem in daySchedule.ThoiKhoaBieu.OrderBy(e => e.NgayLamViec))
                            {
                                if (eventItem.NgayLamViec.HasValue)
                                {
                                    temp = @eventItem.NgayLamViec.Value.Date.ToString("dd/MM/yyyy");
                                    now = Convert.ToDateTime(temp);
                                    a = now.Day - monday.Day;
                                }
                                else
                                {
                                    a = 0;
                                }
                                if (a == daySchedule.idThu)
                                {
                                    <li class="cd-schedule__event">
                                        <a data-start="@eventItem.KhungGio.GioBatDau" data-end="@eventItem.KhungGio.GioKetThuc" data-event="event-4">
                                            <em class="cd-schedule__name">@eventItem.Phong.TenPhong-@eventItem.KhungGio.TenCa</em>
                                            <em class="cd-schedule__name">@eventItem.AspNetUsers.FullName</em>
                                            @if (eventItem.NgayLamViec.HasValue)
                                            {
                                                <em class="cd-schedule__name">@eventItem.NgayLamViec.Value.Date.ToString("yyyy-MM-dd")</em>
                                            }
                                        </a>
                                    </li>
                                }
                            }
                        </ul>
                    </li>
                }
            </ul>
        </div>

        <div class="cd-schedule-modal">
            <header class="cd-schedule-modal__header">
                <div class="cd-schedule-modal__content">
                    <span class="cd-schedule-modal__date"></span>
                    <h3 class="cd-schedule-modal__name"></h3>
                </div>

                <div class="cd-schedule-modal__header-bg"></div>
            </header>

            <div class="cd-schedule-modal__body">
                <div class="cd-schedule-modal__event-info">
                    <h1> hehee</h1>
                </div>
                <div class="cd-schedule-modal__body-bg"></div>
            </div>

            <a href="#0" class="cd-schedule-modal__close text-replace">Close</a>
        </div>
        <div class="cd-schedule__cover-layer"></div>
    }
    else
    {
        <p>Không có dữ liệu thời khóa biểu.</p>
    }

</div> <!-- .cd-schedule -->

@if (Model.DanhSachThoiKhoaBieu.PageCount > 1)
{
    <!-- Hiển thị phân trang nếu có nhiều trang -->
    <div class="pager-container">
        @Html.PagedListPager(Model.DanhSachThoiKhoaBieu, page => Url.Action("TKB", new { page, selectedWeek = Model.SelectedWeek }))
    </div>
}

<script src="~/Areas/assetsTKB/js/util.js"></script> <!-- util functions included in the CodyHouse framework -->
<script src="~/Areas/assetsTKB/js/main.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    $(document).ready(function () {
        // Bạn không cần sự kiện onchange trực tiếp trong thẻ select
        // Sử dụng jQuery để bắt sự kiện onchange
        $('#weekSelect').change(function () {
            var selectedWeek = $(this).val();

            // Tạo URL dựa trên tuần đã chọn và chuyển hướng
            window.location.href = "@Url.Action("TKB")" + "?page=1&selectedWeek=" + selectedWeek;
        });
    });
</script>

