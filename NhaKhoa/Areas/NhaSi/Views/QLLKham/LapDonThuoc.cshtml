@model NhaKhoa.Models.LapDonThuocViewModel

@{
    ViewBag.Title = "LapDonThuoc";
    Layout = "~/Areas/NhaSi/Views/Shared/Layout.cshtml";
}

<h2>LapDonThuoc</h2>

<div class="form-group">
    <label for="searchMedicine">Tìm kiếm thuốc:</label>
    <input type="text" id="searchMedicine" class="form-control" />
</div>

<!-- Hiển thị kết quả tìm kiếm -->
<div id="searchResults" style="display:none;">
    <ul id="medicineList"></ul>
</div>

<div class="form-group">
    <label for="selectedMedicines">Thuốc đã chọn:</label>
    <table id="selectedMedicinesTable" class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>Tên Thuốc</th>
                <th>Số Lượng</th>
                <!--Thêm các cột khác cần thiết-->
            </tr>
        </thead>
        <tbody id="selectedMedicinesList"></tbody>
    </table>
</div>

<div class="form-group">
    <input type="submit" value="Create Prescription" class="btn btn-primary" />
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            updateTotalQuantity();

            $(".form-control").on("change", function () {
                updateTotalQuantity();
            });

            function updateTotalQuantity() {
                var totalQuantity = 0;

                $(".form-control").each(function () {
                    var quantity = parseInt($(this).val()) || 0;
                    if ($(this).closest(".checkbox").find(":checkbox").is(":checked")) {
                        totalQuantity += quantity;
                    }
                });

                $("#DonThuoc_Soluong").val(totalQuantity);
            }
        });

        var selectedMedicines = [];

        window.saveToTable = function (medicineId) {
            $.ajax({
                url: "/QLLKham/SaveToTable",
                method: "POST",
                data: { medicineId: medicineId },
                success: function (data) {
                    if (!isMedicineAlreadySelected(data.Id_thuoc)) {
                        selectedMedicines.push(data);
                        updateSelectedMedicinesCount();
                        updateSelectedMedicinesList();
                    }
                }
            });
        };

        function isMedicineAlreadySelected(medicineId) {
            return selectedMedicines.some(function (medicine) {
                return medicine.Id_thuoc === medicineId;
            });
        }

        function updateSelectedMedicinesCount() {
            var selectedCount = selectedMedicines.length;
            $("#DonThuoc_Soluong").val(selectedCount);
        }

        function updateSelectedMedicinesList() {
            var $list = $("#selectedMedicinesList");
            $list.empty();

            $.each(selectedMedicines, function (index, medicine) {
                $list.append("<tr><td>" + (index + 1) + "</td><td>" + medicine.Tenthuoc + "</td><td>" + medicine.SoLuong + "</td></tr>");
            });
        }

        $("#searchMedicine").on("keyup", function () {
            var searchTerm = $(this).val();

            $.ajax({
                url: "/QLLKham/SearchMedicine",
                method: "POST",
                data: { searchTerm: searchTerm },
                success: function (data) {
                    $("#medicineList").empty();
                    $.each(data, function (index, item) {
                        $("#medicineList").append('<li><a href="#" onclick="saveToTable(' + item.Id_thuoc + ')">' + item.Tenthuoc + '</a></li>');
                    });

                    $("#searchResults").show();
                }
            });
        });
    </script>
}
